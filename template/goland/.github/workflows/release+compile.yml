name: "Release & Compile"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch from which we make a release"
        default: "main"
        required: false

env:
  GO_VERSION: "1.24.2"
  BUILD_CLI: "" #./cli/...
  RELEASE_COMMAND: "git add -f target"
  PUSH_BRANCH: ${{ github.repository.default_branch }}

jobs:
  prepare:
    name: "ðŸ”§ Prepare"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ›Žï¸ Checkout ${{ env.PUSH_BRANCH }}
        uses: actions/checkout@v4
        with:
          ref: ${{ env.PUSH_BRANCH }}
          fetch-depth: 1

      - uses: ./.github/actions/init-go
        with:
          go-version: ${{ env.GO_VERSION }}

      - uses: ./.github/actions/generate-build-env

      - uses: ./.github/actions/tidy-all-and-generate

      - name: ðŸ“¦ Save the repository as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: src-gen
          path: .

  build:
    name: "ðŸ› ï¸ Build [${{ matrix.os }}]"
    needs: [ prepare ]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]

    steps:
      - name: ðŸ›Žï¸ Checkout ${{ env.PUSH_BRANCH }}
        uses: actions/checkout@v4
        with:
          ref: ${{ env.PUSH_BRANCH }}
          fetch-depth: 1

      - name: ðŸ“¥ Download src-gen
        uses: actions/download-artifact@v4
        with:
          name: src-gen
          path: .

      - name: ðŸ—’ï¸ Source .env
        shell: bash
        run: cat build_env.txt >> $GITHUB_ENV

      - uses: ./.github/actions/init-go
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: ðŸ› ï¸ go build
        id: build
        shell: bash
        run: |
          set -Eeuo pipefail
          
          case "${{ runner.os }}" in
            Windows) out="${{ env.BUILD_NAME }}.windows.exe" ;;
            Linux)   out="${{ env.BUILD_NAME }}.linux.bin"   ;;
            *)   out="${{ env.BUILD_NAME }}.darwin.bin"  ;;
          esac
          
          go mod tidy
          go build -ldflags="-s -w" -o "$out" ${{ env.PUSH_BRANCH }}
          [[ "$out" == *.bin ]] && chmod +x "$out"
          
          echo "OUT=$out"           >> $GITHUB_ENV 
          echo "out=$out"           >> $GITHUB_OUTPUT


      - name: ðŸ“¦ Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.out }}
          if-no-files-found: error
          path: ${{ steps.build.outputs.out }}

  release:
    name: "ðŸš€ Publication of release"
    needs: [ build ]
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: ðŸ›Žï¸ Checkout ${{ env.PUSH_BRANCH }}
        uses: actions/checkout@v4
        with:
          ref: ${{ env.PUSH_BRANCH }}
          fetch-depth: 1

      - name: ðŸ“¥ Download src-gen
        uses: actions/download-artifact@v4
        with:
          name: src-gen
          path: .

      - name: ðŸ—’ï¸ Source env
        shell: bash
        run: cat build_env.txt >> $GITHUB_ENV

      - name: ðŸ“¥ Download binaries
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ env.BUILD_NAME }}.*
          merge-multiple: true
          path: dist

      - uses: ./.github/actions/github-setup-user

      - name: ðŸ·ï¸ Create Commit without â€œheavyâ€ and tag ${BUILD_VER}
        id: tag
        shell: bash
        env:
          GOFLAGS: -mod=mod
        run: |
          set -Eeuo pipefail
          ORIG_SHA=$(git rev-parse HEAD)
          
          ${{ env.RELEASE_COMMAND }}

          git rm -f -r --cached --ignore-unmatch .github .idea _generate _run cli gen.go .gitignore
          #git rm -f --cached --ignore-unmatch $(git ls-files '*.bin' '*.md')
          
          git commit -m "release(${BUILD_VER}): strip heavy assets"
          git tag -a "${BUILD_VER}" -m "Release ${BUILD_VER}"
          git push origin "${BUILD_VER}"

          git reset --hard "$ORIG_SHA"

      - name: ðŸš€ Create a release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.BUILD_VER }}
          name: ${{ env.BUILD_VER }}
          generate_release_notes: true
          files: |
            dist/**/*.bin
            dist/**/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ”ï¸ Finish
        run: |
          new_version=$(./_run/scripts/sys.sh --increment --minor)
          
          git add ./_run/values/ver.txt
          git commit -m "actions [$new_version] "$'\n'"Build: [${BUILD_VER}] >> [$new_version]"
          git push origin HEAD:main
          
          echo "ðŸŽ‰ Release $BUILD_VER successfully published!"

      - name: ðŸ§¹ Remove temporary artifacts
        if: success()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            build-env
            src-gen
            ${{ env.BUILD_NAME }}.*
          failOnError: false